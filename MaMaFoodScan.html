<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaMaScan - Association MaMaMa</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link rel="stylesheet" href="MaMaStyle.css">

</head>
<body>
    <div class="header">
        <img src="https://images.squarespace-cdn.com/content/v1/5ec8595ff51b0459bf5c59d8/d36a9706-f7a7-444a-9a13-fb2ee27373e8/mamama_logo.png?format=1500w" alt="Association MaMaMa" class="logo">
    </div>
    <div class="container">
        <h1>MaMaFoodScan</h1>
        <div class="instructions">
            <ol>
                <li>Scannez le code-barres du produit</li>
                <li>Les informations du produit s'affichent</li>
                <li>Cliquez sur "Ajouter" pour l'ajouter au tableau</li>
                <li>Utilisez les boutons "Copier" pour exporter le tableau dans votre feuille GoogleSheet</li>
            </ol>
        </div>
        <div id="csvUploadSection" class="csv-upload" style="display: none;">
            <input type="file" id="csvFile" accept=".csv" onchange="loadCSVFile(event)">
            <label for="csvFile" class="upload-button">Charger le fichier CSV</label>
        </div>
        <div class="scan-section">
            <div id="scanner-view" class="scanner-container">
                <div id="interactive" class="viewport"></div>
                <div id="result"></div>
            </div>
            <div id="product-view" class="result-container" style="display: none;">
                <div id="product-info" class="product-info"></div>
                <div class="button-container">
                    <button id="addButton" class="add-button" disabled>Ajouter</button>
                    <button id="newScanButton" class="new-scan-button">Nouveau scan</button>
                </div>
            </div>
        </div>

        <!-- Popup pour la saisie du nombre d'unités -->
        <div id="unitsPopup" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Nombre d'unités dans le paquet</h3>
                <p class="subtitle">Si produit seul, indiquer 1</p>
                <input type="text" id="unitsInput" readonly>
                <div class="numeric-keypad">
                    <button onclick="addNumber('1', 'units')">1</button>
                    <button onclick="addNumber('2', 'units')">2</button>
                    <button onclick="addNumber('3', 'units')">3</button>
                    <button onclick="addNumber('4', 'units')">4</button>
                    <button onclick="addNumber('5', 'units')">5</button>
                    <button onclick="addNumber('6', 'units')">6</button>
                    <button onclick="addNumber('7', 'units')">7</button>
                    <button onclick="addNumber('8', 'units')">8</button>
                    <button onclick="addNumber('9', 'units')">9</button>
                    <button onclick="addNumber('0', 'units')">0</button>
                    <button onclick="clearNumber('units')">C</button>
                    <button onclick="validateUnits()">OK</button>
                </div>
            </div>
        </div>

        <!-- Popup pour la saisie du poids -->
        <div id="weightPopup" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Poids du paquet en grammes</h3>
                <input type="text" id="weightInput" readonly>
                <div class="numeric-keypad">
                    <button onclick="addNumber('1', 'weight')">1</button>
                    <button onclick="addNumber('2', 'weight')">2</button>
                    <button onclick="addNumber('3', 'weight')">3</button>
                    <button onclick="addNumber('4', 'weight')">4</button>
                    <button onclick="addNumber('5', 'weight')">5</button>
                    <button onclick="addNumber('6', 'weight')">6</button>
                    <button onclick="addNumber('7', 'weight')">7</button>
                    <button onclick="addNumber('8', 'weight')">8</button>
                    <button onclick="addNumber('9', 'weight')">9</button>
                    <button onclick="addNumber('0', 'weight')">0</button>
                    <button onclick="clearNumber('weight')">C</button>
                    <button onclick="validateWeight()">OK</button>
                </div>
            </div>
        </div>

        <!-- Popup pour la saisie du nombre de paquets -->
        <div id="quantityPopup" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Nombre de paquets</h3>
                <input type="text" id="quantityInput" readonly>
                <div class="numeric-keypad">
                    <button onclick="addNumber('1', 'quantity')">1</button>
                    <button onclick="addNumber('2', 'quantity')">2</button>
                    <button onclick="addNumber('3', 'quantity')">3</button>
                    <button onclick="addNumber('4', 'quantity')">4</button>
                    <button onclick="addNumber('5', 'quantity')">5</button>
                    <button onclick="addNumber('6', 'quantity')">6</button>
                    <button onclick="addNumber('7', 'quantity')">7</button>
                    <button onclick="addNumber('8', 'quantity')">8</button>
                    <button onclick="addNumber('9', 'quantity')">9</button>
                    <button onclick="addNumber('0', 'quantity')">0</button>
                    <button onclick="clearNumber('quantity')">C</button>
                    <button onclick="validateQuantity()">OK</button>
                </div>
            </div>
        </div>

        <!-- Popup pour les produits non trouvés -->
        <div id="notFoundPopup" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Produit non trouvé</h3>
                <p>Veuillez sélectionner le type de produit :</p>
                <div class="button-container" style="margin-top: 20px;">
                    <button class="category-button" onclick="selectCategory('food')">Alimentaire</button>
                    <button class="category-button" onclick="selectCategory('beauty')">Hygiène</button>
                </div>
            </div>
        </div>

        <!-- Popup pour la catégorie alimentaire -->
        <div id="foodCategoryPopup" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Sélectionnez la catégorie alimentaire</h3>
                <div class="button-container" style="margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button class="category-button" onclick="selectFoodCategory('Lait 1')">Lait 1</button>
                    <button class="category-button" onclick="selectFoodCategory('Lait 2')">Lait 2</button>
                    <button class="category-button" onclick="selectFoodCategory('Lait 3')">Lait 3</button>
                    <button class="category-button" onclick="selectFoodCategory('Lait 4')">Lait 4</button>
                    <button class="category-button" onclick="selectFoodCategory('Plat 4m+')">Plat 4m+</button>
                    <button class="category-button" onclick="selectFoodCategory('Plat 6m+')">Plat 6m+</button>
                    <button class="category-button" onclick="selectFoodCategory('Plat 8m+')">Plat 8m+</button>
                    <button class="category-button" onclick="selectFoodCategory('Plat 12m+')">Plat 12m+</button>
                    <button class="category-button" onclick="selectFoodCategory('Lactés 4m+')">Lactés 4m+</button>
                    <button class="category-button" onclick="selectFoodCategory('Lactés 6m+')">Lactés 6m+</button>
                    <button class="category-button" onclick="selectFoodCategory('Lactés 12m+')">Lactés 12m+</button>
                    <button class="category-button" onclick="selectFoodCategory('Compotes 4m+')">Compotes 4m+</button>
                    <button class="category-button" onclick="selectFoodCategory('Compotes 6m+')">Compotes 6m+</button>
                    <button class="category-button" onclick="selectFoodCategory('Compotes 12m+')">Compotes 12m+</button>
                    <button class="category-button" onclick="selectFoodCategory('Céréales 6m+')">Céréales 6m+</button>
                    <button class="category-button" onclick="showOtherFoodCategory()">Autre</button>
                </div>
            </div>
        </div>

        <!-- Popup pour la catégorie "Autre" -->
        <div id="otherFoodCategoryPopup" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Précisez la catégorie</h3>
                <input type="text" id="otherFoodCategoryInput" placeholder="Entrez la catégorie">
                <div class="button-container" style="margin-top: 20px;">
                    <button class="category-button" onclick="validateOtherFoodCategory()">Valider</button>
                </div>
            </div>
        </div>

        <!-- Popup pour la saisie du nom du produit -->
        <div id="namePopup" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Nom du produit</h3>
                <input type="text" id="nameInput" placeholder="Entrez le nom du produit">
                <div class="button-container" style="margin-top: 20px;">
                    <button class="category-button" onclick="validateName()">Valider</button>
                </div>
            </div>
        </div>

        <!-- Popup pour la modification du produit -->
        <div id="editPopup" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Modifier le produit</h3>
                <div class="edit-form">
                    <div class="form-group">
                        <label for="editName">Nom du produit</label>
                        <input type="text" id="editName" placeholder="Nom du produit">
                    </div>
                    <div class="form-group">
                        <label for="editCode">Code-barres</label>
                        <input type="text" id="editCode" placeholder="Code-barres">
                    </div>
                    <div class="form-group">
                        <label for="editCategory">Catégorie</label>
                        <input type="text" id="editCategory" placeholder="Catégorie">
                    </div>
                    <div class="form-group">
                        <label for="editUnits">Unités/paquet</label>
                        <input type="text" id="editUnits" placeholder="Nombre d'unités">
                    </div>
                    <div class="form-group">
                        <label for="editWeight">Poids (g)</label>
                        <input type="text" id="editWeight" placeholder="Poids en grammes">
                    </div>
                    <div class="form-group">
                        <label for="editQuantity">Nombre de paquets</label>
                        <input type="text" id="editQuantity" placeholder="Nombre de paquets">
                    </div>
                </div>
                <div class="button-container" style="margin-top: 20px;">
                    <button class="category-button" onclick="saveEdit()">Enregistrer</button>
                    <button class="category-button" onclick="cancelEdit()">Annuler</button>
                </div>
            </div>
        </div>

        <!-- Popup pour la catégorie hygiène -->
        <div id="hygieneCategoryPopup" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Sélectionnez la catégorie d'hygiène</h3>
                <div class="button-container" style="margin-top: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button class="category-button" onclick="selectHygieneCategory('Couches T1')">Couches T1</button>
                    <button class="category-button" onclick="selectHygieneCategory('Couches T2')">Couches T2</button>
                    <button class="category-button" onclick="selectHygieneCategory('Couches T3')">Couches T3</button>
                    <button class="category-button" onclick="selectHygieneCategory('Couches T4')">Couches T4</button>
                    <button class="category-button" onclick="selectHygieneCategory('Couches T5')">Couches T5</button>
                    <button class="category-button" onclick="selectHygieneCategory('Couches T6')">Couches T6</button>
                    <button class="category-button" onclick="selectHygieneCategory('Liniment')">Liniment</button>
                    <button class="category-button" onclick="selectHygieneCategory('Cotons')">Cotons</button>
                    <button class="category-button" onclick="selectHygieneCategory('Lingettes')">Lingettes</button>
                    <button class="category-button" onclick="selectHygieneCategory('Gel lavant bébé')">Gel lavant bébé</button>
                    <button class="category-button" onclick="selectHygieneCategory('Lait de toilette')">Lait de toilette</button>
                    <button class="category-button" onclick="selectHygieneCategory('Cotons-tiges')">Cotons-tiges</button>
                    <button class="category-button" onclick="selectHygieneCategory('Brosse à dent')">Brosse à dent</button>
                    <button class="category-button" onclick="selectHygieneCategory('Dentifrice')">Dentifrice</button>
                    <button class="category-button" onclick="selectHygieneCategory('Déodorant')">Déodorant</button>
                    <button class="category-button" onclick="selectHygieneCategory('Serviettes hygiéniques')">Serviettes hygiéniques</button>
                    <button class="category-button" onclick="selectHygieneCategory('Shampoing adulte')">Shampoing adulte</button>
                    <button class="category-button" onclick="selectHygieneCategory('Shampoing bébé')">Shampoing bébé</button>
                    <button class="category-button" onclick="selectHygieneCategory('Sérum physiologique')">Sérum physiologique</button>
                </div>
            </div>
        </div>

        <!-- Ajouter le popup pour la saisie du code-barres -->
        <div id="barcodePopup" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Code-barres du produit</h3>
                <input type="text" id="barcodeInput" placeholder="Entrez le code-barres">
                <div class="button-container" style="margin-top: 20px;">
                    <button class="category-button" onclick="validateBarcode()">Valider</button>
                </div>
            </div>
        </div>

        <div class="added-products">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <h3>Produits ajoutés :</h3>
                <div class="copy-buttons">
                    <button class="copy-button" onclick="copyToClipboard(true)">Copier avec en-têtes</button>
                    <button class="copy-button" onclick="copyToClipboard(false)">Copier sans en-têtes</button>
                    <button class="remove-button" onclick="deleteAllProducts()">Tout supprimer</button>
                </div>
            </div>
            <div id="copyMessage" class="copy-message">Tableau copié !</div>
            <div id="addedProductsList"></div>
        </div>
    </div>
    <div class="footer">
        Pour toute idée d'amélioration, contactez Natacha : <a href="mailto:digital@asso-mamama.fr">digital@asso-mamama.fr</a>
    </div>

    <script>
        let currentProduct = null;
        let addedProducts = [];
        let lastDatabaseUsed = 'beauty';
        let searchAttempts = 0;
        let previousResults = null;
        let notFoundProduct = null;
        let editingProduct = null;
        let localProducts = null;

        // Charger les produits depuis le localStorage au démarrage
        function loadProductsFromStorage() {
            const savedProducts = localStorage.getItem('addedProducts');
            if (savedProducts) {
                addedProducts = JSON.parse(savedProducts);
                updateAddedProductsList();
            }
        }

        // Sauvegarder les produits dans le localStorage
        function saveProductsToStorage() {
            localStorage.setItem('addedProducts', JSON.stringify(addedProducts));
        }

        // Fonction pour supprimer tous les produits
        function deleteAllProducts() {
            if (confirm('Êtes-vous sûr de vouloir supprimer tous les produits ?')) {
                addedProducts = [];
                localStorage.removeItem('addedProducts');
                updateAddedProductsList();
            }
        }

        // Fonction pour traiter le texte CSV
        function processCSVText(csvText) {
            const lines = csvText.split('\n');
            localProducts = {};
            
            // Ignorer l'en-tête et traiter chaque ligne
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const [code, name, category, units, weight] = line.split('\t');
                    if (code) {
                        // Nettoyer le code-barres (supprimer les espaces et caractères spéciaux)
                        const cleanCode = code.trim().replace(/[^0-9]/g, '');
                        localProducts[cleanCode] = {
                            code: cleanCode,
                            name: name || 'Produit sans nom',
                            category: category || 'Inconnu',
                            units: units || 'inconnu',
                            weight: weight || 'inconnu'
                        };
                    }
                }
            }
            console.log('Produits locaux chargés:', localProducts);
            // Vérifier si un produit est déjà scanné
            if (window.lastScannedCode) {
                fetchProductInfo(window.lastScannedCode);
            }
        }

        // Fonction pour charger le fichier CSV par défaut
        async function loadDefaultCSV() {
            try {
                const response = await fetch('products.csv');
                if (!response.ok) {
                    throw new Error('Fichier non trouvé');
                }
                const csvText = await response.text();
                processCSVText(csvText);
                console.log('Fichier CSV par défaut chargé avec succès');
            } catch (error) {
                console.log('Impossible de charger le fichier CSV par défaut:', error);
                // Afficher le bouton de chargement manuel
                document.getElementById('csvUploadSection').style.display = 'block';
            }
        }

        // Fonction pour charger le fichier CSV localement
        function loadCSVFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    processCSVText(e.target.result);
                };
                reader.readAsText(file);
            }
        }

        // Charger le fichier CSV par défaut au démarrage
        loadDefaultCSV();

        // Charger les produits au démarrage
        loadProductsFromStorage();

        // Fonction pour basculer entre les vues
        function toggleViews(showScanner) {
            const scannerView = document.getElementById('scanner-view');
            const productView = document.getElementById('product-view');
            
            if (showScanner) {
                scannerView.style.display = 'flex';
                productView.style.display = 'none';
                // Ne pas arrêter le scanner, juste le masquer
                document.querySelector('#interactive').style.display = 'block';
            } else {
                scannerView.style.display = 'none';
                productView.style.display = 'block';
                // Masquer le scanner sans l'arrêter
                document.querySelector('#interactive').style.display = 'none';
            }
        }

        // Fonction pour attendre un certain temps
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function selectCategory(category) {
            if (notFoundProduct) {
                if (category === 'food') {
                    document.getElementById('notFoundPopup').style.display = 'none';
                    document.getElementById('namePopup').style.display = 'flex';
                    document.getElementById('nameInput').value = '';
                } else {
                    notFoundProduct.category = 'Hygiène';
                    notFoundProduct.units = '1';
                    notFoundProduct.weight = '0';
                    document.getElementById('notFoundPopup').style.display = 'none';
                    document.getElementById('namePopup').style.display = 'flex';
                    document.getElementById('nameInput').value = '';
                }
            }
        }

        function selectFoodCategory(category) {
            if (notFoundProduct) {
                notFoundProduct.category = category;
                document.getElementById('foodCategoryPopup').style.display = 'none';
                document.getElementById('unitsPopup').style.display = 'flex';
                document.getElementById('unitsInput').value = '';
            }
        }

        function showOtherFoodCategory() {
            document.getElementById('foodCategoryPopup').style.display = 'none';
            document.getElementById('otherFoodCategoryPopup').style.display = 'flex';
            document.getElementById('otherFoodCategoryInput').value = '';
        }

        function validateOtherFoodCategory() {
            const category = document.getElementById('otherFoodCategoryInput').value.trim();
            if (category) {
                notFoundProduct.category = category;
                window.tempProduct = notFoundProduct;
                document.getElementById('otherFoodCategoryPopup').style.display = 'none';
                document.getElementById('quantityPopup').style.display = 'flex';
                document.getElementById('quantityInput').value = '';
            }
        }

        function validateName() {
            const name = document.getElementById('nameInput').value.trim();
            if (name) {
                notFoundProduct.name = name;
                document.getElementById('namePopup').style.display = 'none';
                
                if (notFoundProduct.category === 'Hygiène') {
                    document.getElementById('hygieneCategoryPopup').style.display = 'flex';
                } else {
                    document.getElementById('foodCategoryPopup').style.display = 'flex';
                }
            }
        }

        function selectHygieneCategory(category) {
            if (notFoundProduct) {
                notFoundProduct.category = category;
                document.getElementById('hygieneCategoryPopup').style.display = 'none';
                document.getElementById('unitsPopup').style.display = 'flex';
                document.getElementById('unitsInput').value = '';
            }
        }

        function isValidBarcode(code) {
            // Vérifier si c'est un code numérique
            if (!/^\d+$/.test(code)) {
                return false;
            }

            // Vérifier les formats courants
            const length = code.length;
            if (length === 13) { // EAN-13
                return true;
            } else if (length === 8) { // EAN-8
                return true;
            } else if (length === 12) { // UPC-A
                return true;
            } else if (length >= 6 && length <= 8) { // UPC-E
                return true;
            }

            return false;
        }

        function showInvalidBarcodePopup() {
            const productInfoDiv = document.getElementById('product-info');
            productInfoDiv.innerHTML = `
                <div class="error">Format de code-barres non reconnu</div>
                <div class="button-container" style="margin-top: 20px;">
                    <button class="add-button" onclick="showNotFoundPopup('')">Ajouter manuellement</button>
                </div>
            `;
            toggleViews(false);
        }

        async function fetchProductInfo(code) {
            const productInfoDiv = document.getElementById('product-info');
            productInfoDiv.innerHTML = '<div class="loading">Recherche des informations...</div>';
            toggleViews(false);

            try {
                // Nettoyer le code-barres pour la recherche
                const cleanCode = code.trim().replace(/[^0-9]/g, '');

                // Vérifier d'abord dans les produits locaux
                if (localProducts && localProducts[cleanCode]) {
                    const localProduct = localProducts[cleanCode];
                    currentProduct = localProduct;
                    window.lastScannedProduct = currentProduct;
                    updateAddButton();
                    
                    window.tempProduct = {
                        code: localProduct.code,
                        name: localProduct.name,
                        category: localProduct.category,
                        units: localProduct.units,
                        weight: localProduct.weight,
                        date: new Date().toLocaleString('fr-FR')
                    };
                    
                    const html = `
                        <h2>${localProduct.name}</h2>
                        <div class="product-details">
                            <p><strong>Catégorie:</strong> ${localProduct.category}</p>
                            <p><strong>Unités par paquet:</strong> ${localProduct.units}</p>
                            <p><strong>Poids:</strong> ${localProduct.weight}</p>
                        </div>
                    `;

                    productInfoDiv.innerHTML = html;
                    return; // Arrêter ici si le produit est trouvé localement
                }

                // Si pas trouvé localement, chercher dans les bases de données externes
                let productFound = false;

                // Essayer d'abord la base alimentaire
                const foodResponse = await fetch(`https://world.openfoodfacts.org/api/v0/product/${cleanCode}.json`);
                const foodData = await foodResponse.json();

                if (foodData.status === 1) {
                    currentProduct = foodData.product;
                    window.lastScannedProduct = currentProduct;
                    updateAddButton();
                    
                    // Extraire les informations pour le tableau
                    const units = currentProduct.packagings?.[0]?.number_of_units || '1';
                    const weight = currentProduct.quantity ? 
                        (currentProduct.quantity.match(/\d+/)?.[0] || '0') : '0';
                    
                    // Stocker les informations pour l'ajout au tableau
                    window.tempProduct = {
                        code: currentProduct.code,
                        name: currentProduct.product_name || 'Produit sans nom',
                        category: currentProduct.categories || 'Alimentaire',
                        units: units,
                        weight: weight,
                        date: new Date().toLocaleString('fr-FR')
                    };
                    
                    const html = `
                        <h2>${currentProduct.product_name || 'Nom non disponible'}</h2>
                        ${currentProduct.image_url ? `<img src="${currentProduct.image_url}" alt="${currentProduct.product_name}">` : ''}
                        <div class="product-details">
                            <p><strong>URL Open Food Facts:</strong> <a href="https://world.openfoodfacts.org/product/${cleanCode}" target="_blank">Voir sur Open Food Facts</a></p>
                            ${currentProduct.packagings && currentProduct.packagings[0] ? `
                                <p><strong>Nombre d'unités:</strong> ${currentProduct.packagings[0].number_of_units || 'Non spécifié'}</p>
                                <p><strong>Quantité par unité:</strong> ${currentProduct.packagings[0].quantity_per_unit || 'Non spécifiée'}</p>
                            ` : ''}
                            ${currentProduct.quantity ? `<p><strong>Quantité:</strong> ${currentProduct.quantity}</p>` : ''}
                            ${currentProduct.categories ? `<p><strong>Catégorie:</strong> ${currentProduct.categories}</p>` : ''}
                        </div>
                        <button class="raw-data-toggle" onclick="toggleRawData()">Afficher les données brutes</button>
                        <div id="rawData" class="raw-data" style="display: none;"></div>
                    `;

                    productInfoDiv.innerHTML = html;
                    document.getElementById('rawData').textContent = JSON.stringify(currentProduct, null, 2);
                    productFound = true;
                }

                // Si pas trouvé dans la base alimentaire, essayer la base hygiène
                if (!productFound) {
                    const beautyResponse = await fetch(`https://world.openbeautyfacts.org/api/v0/product/${cleanCode}.json`);
                    const beautyData = await beautyResponse.json();

                    if (beautyData.status === 1) {
                        currentProduct = beautyData.product;
                        window.lastScannedProduct = currentProduct;
                        updateAddButton();
                        
                        // Extraire les informations pour le tableau
                        const units = '1'; // Par défaut pour les produits d'hygiène
                        const weight = currentProduct.quantity ? 
                            (currentProduct.quantity.match(/\d+/)?.[0] || '0') : '0';
                        
                        // Stocker les informations pour l'ajout au tableau
                        window.tempProduct = {
                            code: currentProduct.code,
                            name: currentProduct.product_name || 'Produit sans nom',
                            category: 'Hygiène',
                            units: units,
                            weight: weight,
                            date: new Date().toLocaleString('fr-FR')
                        };
                        
                        const html = `
                            <h2>${currentProduct.product_name || 'Nom non disponible'}</h2>
                            ${currentProduct.image_url ? `<img src="${currentProduct.image_url}" alt="${currentProduct.product_name}">` : ''}
                            <div class="product-details">
                                <p><strong>URL Open Beauty Facts:</strong> <a href="https://world.openbeautyfacts.org/product/${cleanCode}" target="_blank">Voir sur Open Beauty Facts</a></p>
                                ${currentProduct.brands ? `<p><strong>Marque:</strong> ${currentProduct.brands}</p>` : ''}
                                ${currentProduct.categories ? `<p><strong>Catégorie:</strong> ${currentProduct.categories}</p>` : ''}
                                ${currentProduct.quantity ? `<p><strong>Quantité:</strong> ${currentProduct.quantity}</p>` : ''}
                            </div>
                            <button class="raw-data-toggle" onclick="toggleRawData()">Afficher les données brutes</button>
                            <div id="rawData" class="raw-data" style="display: none;"></div>
                        `;

                        productInfoDiv.innerHTML = html;
                        document.getElementById('rawData').textContent = JSON.stringify(currentProduct, null, 2);
                        productFound = true;
                    }
                }

                // Si pas trouvé dans les deux bases, demander les caractéristiques
                if (!productFound) {
                    currentProduct = null;
                    updateAddButton();
                    productInfoDiv.innerHTML = `
                        <div class="error">Produit non trouvé dans les bases de données</div>
                        <div class="product-details">
                            <p><strong>Code-barres détecté :</strong> ${cleanCode}</p>
                        </div>
                        <div class="button-container" style="margin-top: 20px;">
                            <button class="add-button" onclick="showNotFoundPopup('${cleanCode}')">Ajouter manuellement</button>
                        </div>
                    `;
                }

            } catch (error) {
                currentProduct = null;
                updateAddButton();
                console.error('Erreur:', error);
                productInfoDiv.innerHTML = `
                    <div class="error">Erreur lors de la recherche du produit</div>
                    <div class="product-details">
                        <p><strong>Code-barres détecté :</strong> ${cleanCode}</p>
                    </div>
                    <div class="button-container" style="margin-top: 20px;">
                        <button class="add-button" onclick="showNotFoundPopup('${cleanCode}')">Ajouter manuellement</button>
                    </div>
                `;
            }
        }

        function updateAddButton() {
            const addButton = document.getElementById('addButton');
            addButton.disabled = !currentProduct;
        }

        function addProduct() {
            if (currentProduct) {
                if (!addedProducts.some(p => p.code === currentProduct.code)) {
                    // Afficher le popup pour la saisie du nombre de paquets
                    document.getElementById('quantityPopup').style.display = 'flex';
                    document.getElementById('quantityInput').value = '';
                }
            }
        }

        function addNumber(num, type) {
            const input = document.getElementById(`${type}Input`);
            input.value += num;
        }

        function clearNumber(type) {
            document.getElementById(`${type}Input`).value = '';
        }

        function validateUnits() {
            const units = document.getElementById('unitsInput').value;
            if (units) {
                notFoundProduct.units = units;
                document.getElementById('unitsPopup').style.display = 'none';
                document.getElementById('weightPopup').style.display = 'flex';
                document.getElementById('weightInput').value = '';
            }
        }

        function validateWeight() {
            const weight = document.getElementById('weightInput').value;
            if (weight) {
                notFoundProduct.weight = weight;
                window.tempProduct = notFoundProduct;
                document.getElementById('weightPopup').style.display = 'none';
                document.getElementById('quantityPopup').style.display = 'flex';
                document.getElementById('quantityInput').value = '';
            }
        }

        function validateQuantity() {
            const quantity = document.getElementById('quantityInput').value;
            if (quantity && window.tempProduct) {
                window.tempProduct.number = quantity;
                addedProducts.push(window.tempProduct);
                updateAddedProductsList();
                saveProductsToStorage();
                document.getElementById('quantityPopup').style.display = 'none';
                toggleViews(true);
            }
        }

        function removeProduct(code) {
            addedProducts = addedProducts.filter(p => p.code !== code);
            updateAddedProductsList();
            saveProductsToStorage();
        }

        function editProduct(code) {
            const product = addedProducts.find(p => p.code === code);
            if (product) {
                editingProduct = product;
                document.getElementById('editName').value = product.name;
                document.getElementById('editCode').value = product.code || '';
                document.getElementById('editCategory').value = product.category;
                document.getElementById('editUnits').value = product.units;
                document.getElementById('editWeight').value = product.weight;
                document.getElementById('editQuantity').value = product.number || '1';
                document.getElementById('editPopup').style.display = 'flex';
            }
        }

        function saveEdit() {
            if (editingProduct) {
                editingProduct.name = document.getElementById('editName').value.trim();
                editingProduct.code = document.getElementById('editCode').value.trim();
                editingProduct.category = document.getElementById('editCategory').value.trim();
                editingProduct.units = document.getElementById('editUnits').value.trim();
                editingProduct.weight = document.getElementById('editWeight').value.trim();
                editingProduct.number = document.getElementById('editQuantity').value.trim();
                
                updateAddedProductsList();
                saveProductsToStorage();
                document.getElementById('editPopup').style.display = 'none';
                editingProduct = null;
            }
        }

        function cancelEdit() {
            document.getElementById('editPopup').style.display = 'none';
            editingProduct = null;
        }

        function updateAddedProductsList() {
            const listDiv = document.getElementById('addedProductsList');
            listDiv.innerHTML = `
                <table class="products-table">
                    <thead>
                        <tr>
                            <th>Nom du produit</th>
                            <th>Code-barres</th>
                            <th>Catégorie</th>
                            <th>Unités/paquet</th>
                            <th>Poids (g)</th>
                            <th>Nombre de paquets</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${addedProducts.map(product => `
                            <tr>
                                <td>${product.name || 'Produit sans nom'}</td>
                                <td>${product.code || '-'}</td>
                                <td>${product.category}</td>
                                <td>${product.units}</td>
                                <td>${product.weight}</td>
                                <td>${product.number || '1'}</td>
                                <td>${product.date}</td>
                                <td>
                                    <button class="edit-button" onclick="editProduct('${product.code}')">Modifier</button>
                                    <button class="remove-button" onclick="removeProduct('${product.code}')">Supprimer</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            saveProductsToStorage();
        }

        function copyToClipboard(withHeaders = true) {
            // Sélectionner le tableau
            const table = document.querySelector('.products-table');
            if (!table) {
                return;
            }

            // Créer un élément textarea temporaire pour la copie
            const textarea = document.createElement('textarea');
            
            if (withHeaders) {
                // Copier le tableau complet sans la colonne Action
                const rows = Array.from(table.rows);
                textarea.value = rows.map(row => {
                    const cells = Array.from(row.cells);
                    // Exclure la dernière colonne (Action)
                    return cells.slice(0, -1).map(cell => cell.textContent).join('\t');
                }).join('\n');
            } else {
                // Copier uniquement le contenu (sans les en-têtes et sans la colonne Action)
                const rows = Array.from(table.querySelectorAll('tbody tr'));
                textarea.value = rows.map(row => {
                    const cells = Array.from(row.cells);
                    // Exclure la dernière colonne (Action)
                    return cells.slice(0, -1).map(cell => cell.textContent).join('\t');
                }).join('\n');
            }
            
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                // Afficher le message de confirmation
                const message = document.getElementById('copyMessage');
                message.style.display = 'block';
                // Masquer le message après 2 secondes
                setTimeout(() => {
                    message.style.display = 'none';
                }, 2000);
            } catch (err) {
                console.error('Erreur lors de la copie : ', err);
            }
            
            document.body.removeChild(textarea);
        }

        function toggleRawData() {
            const rawDataDiv = document.getElementById('rawData');
            const button = document.querySelector('.raw-data-toggle');
            if (rawDataDiv.style.display === 'none') {
                rawDataDiv.style.display = 'block';
                button.textContent = 'Masquer les données brutes';
            } else {
                rawDataDiv.style.display = 'none';
                button.textContent = 'Afficher les données brutes';
            }
        }

        function showNotFoundPopup(code) {
            notFoundProduct = {
                code: code,
                name: 'Produit non trouvé',
                quantity: 'Non spécifiée',
                units: 'Non spécifié',
                quantityPerUnit: 'Non spécifiée',
                date: new Date().toLocaleString('fr-FR')
            };
            document.getElementById('barcodePopup').style.display = 'flex';
            document.getElementById('barcodeInput').value = code || '';
        }

        function validateBarcode() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            if (barcode) {
                notFoundProduct.code = barcode;
                document.getElementById('barcodePopup').style.display = 'none';
                document.getElementById('namePopup').style.display = 'flex';
                document.getElementById('nameInput').value = '';
            }
        }

        // Ajouter l'écouteur d'événement pour le bouton "Nouveau scan"
        document.getElementById('newScanButton').addEventListener('click', () => {
            toggleViews(true);
        });

        // Initialiser le scanner au démarrage
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    facingMode: "environment"
                },
                willReadFrequently: true
            },
            decoder: {
                readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader"]
            },
            locate: true,
            frequency: 4
        }, function(err) {
            if (err) {
                console.error(err);
                return;
            }
            console.log("Scanner initialisé");
            Quagga.start();
        });

        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            document.getElementById('result').innerHTML = `Code détecté : ${code}`;
            window.lastScannedCode = code; // Stocker le code pour le cas où le CSV n'est pas encore chargé
            
            if (isValidBarcode(code)) {
                fetchProductInfo(code);
            } else {
                showInvalidBarcodePopup();
            }
        });

        document.getElementById('addButton').addEventListener('click', addProduct);

        // Arrêter le scanner quand la page est quittée
        window.addEventListener('beforeunload', function() {
            Quagga.stop();
        });
    </script>
</body>
</html> 
