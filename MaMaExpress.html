<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaMaExpress - Association MaMaMa</title>
    <link rel="stylesheet" href="MaMaStyle.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .selected-pmi-list {
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        .selected-pmi-title {
            display: block;
            margin-bottom: 8px;
            color: #2C3E50;
        }
        .selected-pmi-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            color: #555;
        }
        .selected-pmi-item {
            padding: 5px;
            font-size: 14px;
        }
        .results-section {
            display: none;
        }
        .results-layout {
            display: flex;
            gap: 20px;
            align-items: stretch;
        }
        .routes-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 600px;
        }
        .routes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .routes-header h3 {
            margin: 0;
        }
        .routes-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        .map-container {
            flex: 1;
            height: 600px;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .duration-note {
            margin-top: 10px;
            padding: 12px;
            background-color: #f5f5f5;
            border-left: 3px solid #666;
            color: #555;
            font-size: 0.9em;
            line-height: 1.5;
        }
        .google-maps-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #4285f4;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://images.squarespace-cdn.com/content/v1/5ec8595ff51b0459bf5c59d8/d36a9706-f7a7-444a-9a13-fb2ee27373e8/mamama_logo.png?format=1500w" alt="Association MaMaMa" class="logo">
    </div>
    <div class="container">
        <h1>MaMaExpress</h1>
        
        <div class="input-section">
            <div class="address-input">
                <h3>S√©lectionner les adresses √† livrer</h3>
                <div class="pmi-controls">
                    <input type="text" id="searchPmi" placeholder="Rechercher" class="search-input">
                    <div class="select-buttons">
                        <button id="selectAll" class="select-button">Tout s√©lectionner</button>
                        <button id="deselectAll" class="select-button">Tout d√©s√©lectionner</button>
                    </div>
                </div>
                <div id="pmiList" class="pmi-list">
                    <p style="color: #666;">Chargement des donn√©es...</p>
                </div>
                <div id="selectedPmiList" class="selected-pmi-list">
                    <strong id="selectedPmiTitle" class="selected-pmi-title">Adresses s√©lectionn√©es :</strong>
                    <div id="selectedPmiItems" class="selected-pmi-items"></div>
                </div>
            </div>
        </div>

        <div id="results" class="results-section">
            <div class="results-layout">
                <div class="routes-list">
                    <div class="routes-header">
                        <h3>Itin√©raire optimis√©</h3>
                        <div id="googleMapsButton"></div>
                    </div>
                    <div id="routes" class="routes-content"></div>
                </div>
                <div id="mapContainer" class="map-container"></div>
            </div>
        </div>
    </div>
    <div class="footer">
        Pour toute id√©e d'am√©lioration, contactez Natacha : <a href="mailto:digital@asso-mamama.fr">digital@asso-mamama.fr</a>
    </div>

    <!-- Fichiers de donn√©es JavaScript (g√©n√©r√©s depuis les CSV) -->
    <script src="pmi_addresses.js"></script>
    <script src="pmi_durees.js"></script>

    <script>
        let allPmis = [];
        let filteredPmis = [];
        let dureesMap = new Map();
        let selectedPmiIndices = new Set();
        let currentMap = null;

        function initializeFromJS() {
            if (typeof PMI_ADDRESSES === 'undefined') {
                console.error('PMI_ADDRESSES non d√©fini');
                document.getElementById('pmiList').innerHTML = 
                    '<p style="color: red;">‚ùå Erreur : Fichier pmi_addresses.js non charg√©</p>';
                return;
            }
            
            if (typeof PMI_DUREES === 'undefined') {
                console.error('PMI_DUREES non d√©fini');
                return;
            }
            
            if (typeof MAMAMA_ADDRESS === 'undefined') {
                MAMAMA_ADDRESS = "rue Louis Girard, Aubervilliers";
            }
            
            allPmis = PMI_ADDRESSES.map(pmi => ({
                nom: pmi.nom,
                address: pmi.address,
                lat: pmi.lat,
                lng: pmi.lng
            }));
            
            filteredPmis = [...allPmis];
            displayPmis();
            updateSelectedCount();
            
            dureesMap.clear();
            for (const [key, value] of Object.entries(PMI_DUREES)) {
                dureesMap.set(key, value);
            }
        }

        function displayPmis() {
            const pmiListDiv = document.getElementById('pmiList');
            
            document.querySelectorAll('.pmi-checkbox:checked').forEach(cb => {
                selectedPmiIndices.add(parseInt(cb.dataset.index));
            });
            
            pmiListDiv.innerHTML = '';
            
            if (filteredPmis.length === 0) {
                pmiListDiv.innerHTML = '<p>Aucune PMI trouv√©e</p>';
                updateSelectedCount(false);
                return;
            }

            filteredPmis.forEach((pmi, index) => {
                const pmiIndex = allPmis.indexOf(pmi);
                const isChecked = selectedPmiIndices.has(pmiIndex);
                
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'pmi-item';
                
                const checkboxInput = document.createElement('input');
                checkboxInput.type = 'checkbox';
                checkboxInput.id = `pmi-${index}`;
                checkboxInput.dataset.index = pmiIndex;
                checkboxInput.className = 'pmi-checkbox';
                checkboxInput.checked = isChecked;
                
                const label = document.createElement('label');
                label.htmlFor = `pmi-${index}`;
                label.innerHTML = `<strong>${pmi.nom}</strong><br><span class="pmi-address">${pmi.address}</span>`;
                
                checkboxDiv.appendChild(checkboxInput);
                checkboxDiv.appendChild(label);
                pmiListDiv.appendChild(checkboxDiv);
            });
            
            pmiListDiv.onchange = (e) => {
                if (e.target.classList.contains('pmi-checkbox')) {
                    const idx = parseInt(e.target.dataset.index);
                    if (e.target.checked) {
                        selectedPmiIndices.add(idx);
                    } else {
                        selectedPmiIndices.delete(idx);
                    }
                    updateSelectedCount(true);
                }
            };
            
            updateSelectedCount(false);
        }

        function filterPmis(searchTerm) {
            if (allPmis.length === 0) return;
            
            const term = (searchTerm || '').toLowerCase().trim();
            filteredPmis = term === '' 
                ? [...allPmis]
                : allPmis.filter(pmi => 
                    (pmi.nom && pmi.nom.toLowerCase().includes(term)) ||
                    (pmi.address && pmi.address.toLowerCase().includes(term))
                );
            
            displayPmis();
        }

        function updateSelectedCount(shouldCalculateRoutes = true) {
            const selected = selectedPmiIndices.size;
            const selectedPmiListDiv = document.getElementById('selectedPmiList');
            const selectedPmiTitle = document.getElementById('selectedPmiTitle');
            const selectedPmiItems = document.getElementById('selectedPmiItems');
            
            if (selected === 0) {
                selectedPmiListDiv.style.display = 'none';
                if (shouldCalculateRoutes) {
                    document.getElementById('results').style.display = 'none';
                }
            } else {
                selectedPmiListDiv.style.display = 'block';
                selectedPmiTitle.textContent = `${selected} adresse${selected > 1 ? 's' : ''} s√©lectionn√©e${selected > 1 ? 's' : ''}`;
                selectedPmiItems.innerHTML = '';
                
                Array.from(selectedPmiIndices)
                    .sort((a, b) => a - b)
                    .forEach(index => {
                        if (allPmis[index]) {
                            const div = document.createElement('div');
                            div.className = 'selected-pmi-item';
                            div.textContent = allPmis[index].nom || allPmis[index].address;
                            selectedPmiItems.appendChild(div);
                        }
                    });
                
                if (shouldCalculateRoutes) {
                    setTimeout(() => calculateRoutes(), 100);
                }
            }
        }

        /**
         * R√©cup√®re l'ID d'une adresse depuis le mapping
         */
        function getAddressId(address) {
            if (!address) return null;
            
            if (typeof PMI_ADDRESS_TO_ID !== 'undefined' && PMI_ADDRESS_TO_ID[address] !== undefined) {
                return PMI_ADDRESS_TO_ID[address];
            }
            
            if (typeof PMI_ADDRESSES !== 'undefined') {
                const pmi = PMI_ADDRESSES.find(p => p.address === address);
                if (pmi) return pmi.id;
            }
            
            if (typeof MAMAMA_ADDRESS !== 'undefined' && address === MAMAMA_ADDRESS) {
                return typeof MAMAMA_ID !== 'undefined' ? MAMAMA_ID : null;
            }
            
            return null;
        }

        function getDuree(adresse1, adresse2) {
            const id1 = getAddressId(adresse1);
            const id2 = getAddressId(adresse2);
            
            if (id1 === null || id2 === null) return Infinity;
            
            const key = `${id1}|${id2}`;
            return dureesMap.get(key) ?? Infinity;
        }

        async function calculateOptimalOrder(waypoints) {
            if (dureesMap.size === 0) {
                throw new Error('Les dur√©es de trajet n\'ont pas √©t√© charg√©es. Veuillez recharger la page.');
            }
            
            const n = waypoints.length;
            const dureesMatrix = [];
            
            for (let i = 0; i < n; i++) {
                dureesMatrix[i] = [];
                for (let j = 0; j < n; j++) {
                    dureesMatrix[i][j] = (i === j) ? 0 : getDuree(waypoints[i].address, waypoints[j].address);
                }
            }

            const visited = new Set([0]);
            const order = [0];
            
            while (visited.size < waypoints.length) {
                let minDuree = Infinity;
                let nextPoint = -1;
                const currentPoint = order[order.length - 1];
                
                for (let i = 0; i < n; i++) {
                    if (!visited.has(i)) {
                        const duree = dureesMatrix[currentPoint][i];
                        if (duree < minDuree) {
                            minDuree = duree;
                            nextPoint = i;
                        }
                    }
                }
                
                if (nextPoint === -1 || minDuree === Infinity) {
                    for (let i = 0; i < n; i++) {
                        if (!visited.has(i)) {
                            nextPoint = i;
                            break;
                        }
                    }
                    if (nextPoint === -1) break;
                }
                
                visited.add(nextPoint);
                order.push(nextPoint);
            }
                
            if (order.length <= 30) {
                let amelioration = true;
                let iterations = 0;
                const maxIterations = 10;
                
                while (amelioration && iterations < maxIterations) {
                    amelioration = false;
                    iterations++;
                    const n = order.length;
                    
                    for (let i = 0; i < n - 2; i++) {
                        for (let j = i + 2; j < n - 1; j++) {
                            const d_i_i1 = dureesMatrix[order[i]][order[i + 1]];
                            const d_j_j1 = dureesMatrix[order[j]][order[j + 1]];
                            const d_i_j = dureesMatrix[order[i]][order[j]];
                            const d_i1_j1 = dureesMatrix[order[i + 1]][order[j + 1]];
                            
                            if (d_i_i1 === Infinity || d_j_j1 === Infinity || 
                                d_i_j === Infinity || d_i1_j1 === Infinity) {
                                continue;
                            }
                            
                            const gain = d_i_i1 + d_j_j1 - d_i_j - d_i1_j1;
                            
                            if (gain > 0) {
                                let start = i + 1;
                                let end = j;
                                while (start < end) {
                                    [order[start], order[end]] = [order[end], order[start]];
                                    start++;
                                    end--;
                                }
                                amelioration = true;
                                break;
                            }
                        }
                        if (amelioration) break;
                    }
                }
            }
            
            return order;
        }

        async function calculateRoutes() {
            document.getElementById('results').style.display = 'none';

            const selectedPmis = Array.from(selectedPmiIndices).map(index => allPmis[index]);
            if (selectedPmis.length === 0) return;

            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                const mamamaLat = 48.90355834151138;
                const mamamaLng = 2.378094237324154;
                
                const locations = [{
                    nom: 'MaMaMa (D√©part)',
                    address: MAMAMA_ADDRESS,
                    lat: mamamaLat,
                    lng: mamamaLng
                }, ...selectedPmis.map(pmi => ({
                    nom: pmi.nom,
                    address: pmi.address,
                    lat: pmi.lat,
                    lng: pmi.lng
                }))];

                const optimalOrder = await calculateOptimalOrder(locations);
                const orderedWaypoints = optimalOrder.map(index => locations[index]);
                displayRoute(orderedWaypoints);
                
            } catch (error) {
                console.error('Erreur:', error);
                alert(`Erreur lors du calcul: ${error.message}`);
            }
        }

        function displayRoute(waypoints) {
            const routesDiv = document.getElementById('routes');
            routesDiv.innerHTML = '';

            const routeDiv = document.createElement('div');
            routeDiv.className = 'route';
            
            let dureeTotale = 0;
            for (let i = 0; i < waypoints.length - 1; i++) {
                const duree = getDuree(waypoints[i].address, waypoints[i + 1].address);
                if (duree !== Infinity) dureeTotale += duree;
            }
            
            const dureeRetour = getDuree(waypoints[waypoints.length - 1].address, waypoints[0].address);
            if (dureeRetour !== Infinity) dureeTotale += dureeRetour;
            
            let html = '';
            if (dureeTotale > 0) {
                const minutesArrondies = Math.round(dureeTotale);
                const heures = Math.floor(dureeTotale / 60);
                const minutesRestantes = Math.round(dureeTotale % 60);
                const formatHeures = minutesRestantes > 0 
                    ? `${heures}h${minutesRestantes.toString().padStart(2, '0')}` 
                    : `${heures}h`;
                html += `<p><strong>Dur√©e totale estim√©e : ${minutesArrondies} minutes (${formatHeures})</strong></p>`;
                html += `<p class="duration-note">
                    <strong>Note :</strong> Les dur√©es indiqu√©es sont des estimations bas√©es sur des conditions de circulation normales. Elles ne prennent pas en compte les bouchons, les accidents, les conditions m√©t√©orologiques ou d'autres √©v√©nements pouvant affecter le trafic. Les temps de trajet r√©els peuvent varier.
                </p>`;
            }
            
            html += `<ol start="0"><li><strong>${waypoints[0].address}</strong> (D√©part)</li>`;
            for (let i = 1; i < waypoints.length; i++) {
                const displayName = waypoints[i].nom 
                    ? `${waypoints[i].nom} - ${waypoints[i].address}` 
                    : waypoints[i].address;
                html += `<li>${displayName}</li>`;
            }
            if (waypoints.length > 1) {
                html += `<li><strong>${waypoints[0].address}</strong> (Retour)</li>`;
            }
            html += `</ol>`;
            
            routeDiv.innerHTML = html;
            routesDiv.appendChild(routeDiv);
            
            const googleMapsButtonDiv = document.getElementById('googleMapsButton');
            googleMapsButtonDiv.innerHTML = '';
            if (waypoints.length > 1) {
                const { url: googleMapsUrl, limited } = buildGoogleMapsUrl(waypoints);
                const mapsLink = document.createElement('a');
                mapsLink.href = googleMapsUrl;
                mapsLink.target = '_blank';
                mapsLink.className = 'google-maps-button';
                mapsLink.textContent = limited 
                    ? 'üó∫Ô∏è Voir l\'itin√©raire (9 premi√®res adresses)'
                    : 'üó∫Ô∏è Voir l\'itin√©raire sur Google Maps';
                googleMapsButtonDiv.appendChild(mapsLink);
            }
            
            displayMap(waypoints);
            document.getElementById('results').style.display = 'block';
        }

        function displayMap(waypoints) {
            try {
                const mapContainer = document.getElementById('mapContainer');
                if (!mapContainer) return;
                
                if (currentMap) {
                    currentMap.remove();
                    currentMap = null;
                }
                
                mapContainer.innerHTML = '';
                if (waypoints.length === 0) return;
            
                const hasCoordinates = waypoints.some(wp => wp.lat && wp.lng);
                if (!hasCoordinates) {
                    mapContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">Coordonn√©es non disponibles</p>';
                    return;
                }
            
                const map = L.map('mapContainer');
                currentMap = map;
            
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
            
                const markers = [];
                const latlngs = [];
            
                if (waypoints[0].lat && waypoints[0].lng) {
                    const startMarker = L.marker([waypoints[0].lat, waypoints[0].lng], {
                        icon: L.divIcon({
                            className: 'custom-marker-start',
                            html: '<div style="background-color: #FFC107; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);
                    startMarker.bindPopup(`<strong>MaMaMa (D√©part/Arriv√©e)</strong><br>${waypoints[0].address}`);
                    markers.push(startMarker);
                    latlngs.push([waypoints[0].lat, waypoints[0].lng]);
                }
            
                for (let i = 1; i < waypoints.length; i++) {
                    const waypoint = waypoints[i];
                    if (waypoint.lat && waypoint.lng) {
                        const marker = L.marker([waypoint.lat, waypoint.lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: `<div style="background-color: #2196F3; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div><div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; font-weight: bold; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">${i}</div>`,
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            })
                        }).addTo(map);
                        
                        const popupText = waypoint.nom 
                            ? `<strong>${i}. ${waypoint.nom}</strong><br>${waypoint.address}`
                            : `<strong>${i}. ${waypoint.address}</strong>`;
                        marker.bindPopup(popupText);
                        markers.push(marker);
                        latlngs.push([waypoint.lat, waypoint.lng]);
                    }
                }
            
                if (latlngs.length > 1) {
                    L.polyline(latlngs, {
                        color: '#2196F3',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(map);
                
                    if (waypoints[0].lat && waypoints[0].lng && 
                        waypoints[waypoints.length - 1].lat && waypoints[waypoints.length - 1].lng) {
                        L.polyline([
                            [waypoints[waypoints.length - 1].lat, waypoints[waypoints.length - 1].lng],
                            [waypoints[0].lat, waypoints[0].lng]
                        ], {
                            color: '#9E9E9E',
                            weight: 3,
                            opacity: 0.5,
                            dashArray: '10, 5'
                        }).addTo(map);
                    }
                }
            
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    setTimeout(() => map.fitBounds(group.getBounds().pad(0.1)), 100);
                } else {
                    map.setView([48.8566, 2.3522], 11);
                }
            } catch (error) {
                console.error('Erreur dans displayMap:', error);
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) {
                    mapContainer.innerHTML = `<p style="padding: 20px; text-align: center; color: red;">Erreur: ${error.message}</p>`;
                }
            }
        }

        function buildGoogleMapsUrl(waypoints) {
            if (waypoints.length === 0) return { url: '', limited: false };
            
            const origin = encodeURIComponent(waypoints[0].address);
            const destination = encodeURIComponent(waypoints[0].address);
            const maxWaypoints = 9;
            const waypointsList = [];
            const limited = waypoints.length > 10;
            
            for (let i = 1; i < waypoints.length && waypointsList.length < maxWaypoints; i++) {
                waypointsList.push(encodeURIComponent(waypoints[i].address));
            }
            
            let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&travelmode=driving`;
            if (waypointsList.length > 0) {
                url += `&waypoints=${waypointsList.join('|')}`;
            }
            
            return { url, limited };
        }

        function selectAllVisible() {
            document.querySelectorAll('.pmi-checkbox').forEach(cb => {
                const idx = parseInt(cb.dataset.index);
                cb.checked = true;
                selectedPmiIndices.add(idx);
            });
            updateSelectedCount();
        }

        function deselectAllVisible() {
            document.querySelectorAll('.pmi-checkbox').forEach(cb => {
                const idx = parseInt(cb.dataset.index);
                cb.checked = false;
                selectedPmiIndices.delete(idx);
            });
            updateSelectedCount();
        }

        function attachEventListeners() {
            const searchPmi = document.getElementById('searchPmi');
            const selectAll = document.getElementById('selectAll');
            const deselectAll = document.getElementById('deselectAll');
            
            if (searchPmi) {
                searchPmi.addEventListener('input', (e) => filterPmis(e.target.value));
            }
            
            if (selectAll) selectAll.addEventListener('click', selectAllVisible);
            if (deselectAll) deselectAll.addEventListener('click', deselectAllVisible);
            
            if (typeof PMI_ADDRESSES !== 'undefined' && typeof PMI_DUREES !== 'undefined') {
                initializeFromJS();
            } else {
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        if (typeof PMI_ADDRESSES !== 'undefined' && typeof PMI_DUREES !== 'undefined') {
                            initializeFromJS();
                        } else {
                            console.error('Donn√©es non disponibles');
                            document.getElementById('pmiList').innerHTML = 
                                '<p style="color: red;">‚ùå Erreur : Fichiers de donn√©es non charg√©s</p>';
                        }
                    }, 100);
                });
            }
        }
        
        attachEventListeners();
    </script>
</body>
</html> 